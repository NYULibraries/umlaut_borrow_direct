<% request_status = responses.find {|r| r.service_type_value_name == "bd_request_status"} %>

<% if (!request_status) && request_form = responses.find {|r| r.service_type_value_name == "bd_request_prompt"} %>
    <%= render "borrow_direct/request_form", :response => request_form %>
<% elsif link_to_search = responses.find {|r| r.service_type_value_name == "bd_link_to_search"  } %>
    <%# display it the normal way with a standard response type %>
    <ul>
        <%= render renderer.item_render_hash(link_to_search) %>
    </ul>

<%  elsif (!request_status) && not_avail = responses.find {|r| r.service_type_value_name == "bd_not_available" } %>
    <%# display custom because we have no URL, and the standard thing insists on a link %>
    <p class="umlaut-unavailable"><%= not_avail.view_data["display_text"] %></p>
<% end %>

<%# we do custom spinner, so we can customize label for 'placing request' %>
<% if renderer.request.service_types_in_progress?(renderer.service_type_values)   %>
    <% 
       render_hash = renderer.spinner_render_hash
       render_hash[:locals][:progress_message] = I18n.t("umlaut.services.borrow_direct_adaptor.bd_request_status.progress") if request_status.try {|sr| sr.view_data[:status] == BorrowDirectController::InProgress}
    %>

    <%= render render_hash %>
<% end %>

<%# do we have an error in the DispatchedService? If so,
    display a warning at bottom of the section no matter what.
    Do we have a bd_request_status with an error? Display it too. %>

<% 
errors = umlaut_request.
    dispatch_objects_with(:service_type_values => UmlautBorrowDirect.service_type_values).
    find_all {|ds| ds.failed? }
if errors.present? 
    %>
    <div class="borrow-direct-error alert alert-danger" role="alert">
        <p><strong>Warning</strong>, there was a software error in determining
            BorrowDirect availability.</p>

        <%  if timeout = errors.find do |ds| 
                ds.exception_info.try {|h| h[:class_name] == "BorrowDirect::HttpTimeoutError"}
            end %>
            <p class="borrow-direct-error-info">
                <%= timeout.exception_info[:message] %>
            </p>
        <% end %>
    </div>
<% end %>